<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="CPH Landing Page Prototype">
  <meta name="author" content="Allen Nikka">
  <link rel="icon" href="../../favicon.ico">

  <title>CPH Monitoring Page</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- Bootstrap theme -->
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

  <!-- Custom styles for this template -->
  <link href="theme.css" rel="stylesheet">

  <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
  <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
  <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body onload="init()">

  <!-- Fixed navbar -->
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        <a class="navbar-brand" href="#">CPH Homepage</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#contact">Contact</a></li>
          <li><a href="#logout" onclick="logout()">Log Out</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="#">Action</a></li>
              <li><a href="#">Another action</a></li>
              <li><a href="#">Something else here</a></li>
              <li role="separator" class="divider"></li>
              <li class="dropdown-header">Nav header</li>
              <li><a href="#">Separated link</a></li>
              <li><a href="#">One more separated link</a></li>
            </ul>
          </li>
        </ul>
      </div>
      <!--/.nav-collapse -->
    </div>
  </nav>

  <div class="container theme-showcase" role="main">

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <h1>Theme example</h1>
      <p>This is a template showcasing the optional theme stylesheet included in Bootstrap. Use it as a starting point to create something more unique by building on or modifying it.</p>
    </div>

    <div class="page-header">
      <h1>Power Consumption</h1>
    </div>
    <p>
      <label> View Past: </label>
      <input type="radio" id="r2" name="display" value="Hour"> Hour
      <input type="radio" id="r3" name="display" value="Day"> Day
      <input type="radio" id="r4" name="display" value="Month" > Month
      <input type="radio" id="r5" name="display" value="Year" checked> Year
    </p>
    <div class="row">
      <div class="col-md-6">
        <table class="table">
          <thead>
            <tr>
              <th>Power</th>
            </tr>
          </thead>
        </table>
        <div class="powerCharts"  id="powerChart">

        </div>
      </div>
      <div class="col-md-6">
        <!-- <div class="col-md-6" id="harmonicsChart">  -->
        <table class="table">
          <thead>
            <tr>
              <th>Harmonics</th>
            </tr>
          </thead>
        </table>
        <div class="harmoicsBars">
          <label>0th Harmonic</label>
          <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 50%;" id="h1_bar"> <label id="h1_bar_label">0th Harmonic</label> </div>
          </div>
          <label>1st Harmonic</label>
          <div class="progress">
            <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%" id="h2_bar"> <label id="h2_bar_label">1st Harmonic </label></div>
          </div>
          <label>2nd Harmonic</label>
          <div class="progress">
            <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 20%" id="h3_bar"><label id="h3_bar_label"> 2nd Harmonic </label></div>
          </div>
          <label>3rd Harmonic</label>
          <div class="progress">
            <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%" id="h4_bar"> <label id="h4_bar_label">3rd Harmonic </label></div>
          </div>
          <label>4th Harmonic</label>
          <div class="progress">
            <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: 80%" id="h5_bar"> <label id="h5_bar_label">4th Harmonic </label></div>
          </div>
          <label>5th Harmonic</label>
          <div class="progress">
            <div class="progress-bar progress-bar-striped" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%" id="h6_bar"> <label id="h6_bar_label">5th Harmonic </label></div>
          </div>
        </div>
      </div>
    </div>

    <div class="page-header" id="Circuit_Controls">
      <h1>Device Management</h1>
    </div>
    <div class="row">
      <div class="col-md-6">
        <p>
          <label>Device Name:</label> <input type="text" id="deviceName"/>
          <button type="button" class="btn btn-sm btn-success">Submit</button>
        </p>
      </div>
      <div class="col-md-6">
        <div id="control">
          <p>
            <form method="post" name="setRelay">
              <labelfor="relay1On">Set Relay 1:</label>
              <input type="radio" id="relay1On" name="setRelay1" value="on" checked> Circuit On
              <input type="radio" id="relay1Off" name="setRelay1" value="off"> Circuit Off
            </form>
          </p>
        </div>
      </div>
    </div>





    <!-- <div class="page-header">
      <h1>All Devices</h1>
    </div> -->

    <div class="row">
      <div class="col-md-6">
        <table class="table">
          <thead>
            <tr>
              <th>Classified Devices</th>
            </tr>
          </thead>
          <tbody id="devices">
          </tbody>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table">
          <thead>
            <tr>
              <th>Active Devices</th>
            </tr>
          </thead>
          <tbody id="successDevices">
          </tbody>
        </table>
      </div>
    </div>

  </div>
  <!-- /container -->


  <!-- Bootstrap core JavaScript
    ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
  <!-- <script>
    window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')
  </script> -->
  <!-- <script src="../../dist/js/bootstrap.min.js"></script> -->
  <!-- <script src="../../assets/js/docs.min.js"></script> -->
  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->

  <script type="text/javascript">

    function logout(){
      window.location.replace('loginV4.html');
    }
    //page load call, to hide elements and make clear the need to log-in
    function init() {
      // document.getElementById("charts").style.display = "none";
      // document.getElementById("devices").style.display = "none";
      // document.getElementById("successDevices").style.display = "none";
      // document.getElementById("Circuit_Controls").style.display = "none";
      // // document.getElementById("r2").style.display = "none";
      // document.getElementById("Control").style.display = "none";
      // document.getElementById("Teaching").style.display = "none";
      updateDisplay();
    }


    //global vars
    var user = 'userA1'; //FIXME: need to use express to do routing and deal with session variables
    var socketio = io.connect();

    //function used to login a user
    function login() {
      var userTemp = document.getElementById("username").value;
      var pass = document.getElementById("password").value;
      if (userTemp === "") {
        alert("You must enter a username");
      } else {
        user = userTemp;
        socketio.emit("login_attempt", {
          userName: user,
          password: pass
        });
      }
    }


    //update graphs
    function updateDisplay() {
      // console.log("Display updated")
      var dimension;
      if (document.getElementById('r2').checked) {
        dimension = document.getElementById('r2').value;
      }
      if (document.getElementById('r3').checked) {
        dimension = document.getElementById('r3').value;
      }
      if (document.getElementById('r4').checked) {
        dimension = document.getElementById('r4').value;
      }
      if (document.getElementById('r5').checked) {
        dimension = document.getElementById('r5').value;
      }
      if(user) {
        // alert("Resize Display: " +dimension + " by " + user);
        socketio.emit("updateDisplay", {
          user: user,
          dimension: dimension,
          resize: true
        });
      }

    }

    //call used to begin creation of device
    function createDevice(number) {
      if (number == 1) {
        alert("number is 1!");
      }

      var deviceName = document.getElementById("deviceName").value;
      document.getElementById("deviceName").value = '';

      socketio.emit("createDevice", {
        user: user,
        deviceName: deviceName
      });
    }


    //updating screen in response to successful login
    socketio.on("loginResult", function(data) {
      if (!data.successUser) {
        alert("Username not recognized");
      } else {
        if (!data.successPass) {
          alert("Password incorrect");
        }
      }
      if (data.successUser && data.successPass) {
        alert(data.user + " is logged-in");
        user = data.user;
        document.getElementById("charts").style.display = "block";
        document.getElementById("devices").style.display = "block";
        document.getElementById("successDevices").style.display = "block";
        document.getElementById("Circuit_Controls").style.display = "block";
        document.getElementById("login").style.display = "none";
        document.getElementById("Control").style.display = "block";

        document.getElementById("devices").innerHTML = "Identified devices: ";
        document.getElementById("successDevices").innerHTML = "Currently powered devices: ";

        updateDisplay();
        socketio.emit("pullDevices", {
          user: user
        });

      }
    });

    //Relay control functions
    document.getElementById("relay1On").onclick = function() {
      socketio.emit("setRelay", {
        name: 'setRelay1',
        data: "ON"
      });
    }

    document.getElementById("relay1Off").onclick = function() {
      socketio.emit("setRelay", {
        name: 'setRelay1',
        data: "OFF"
      });
    }

    // view radio buttons
    for (var i = 2; i < 6; i++) {
      document.getElementById("r"+i).onclick = function() {
          updateDisplay();
      }
    }
    //
    // function emitDisplay(element) {
    //
    //   socketio.emit("updateDisplay", {
    //     user: user,
    //     view: element.value
    //   });
    // }

    //response to success full logged change
    socketio.on("changeLogged", function(data) {
      // alert("change logged"); //FIXME: commented this because it was getting annoying
      updateDisplay();
      var learningModeOn = false;
      if (document.getElementById("learningOn").checked) {
        learningModeOn = true;
      }
      socketio.emit("pullDevices", {
        user: user,
        learningModeOn: learningModeOn
      });

    });
    //response to device being successfully created
    socketio.on("deviceCreated", function(data) {
      if(!(data.error)){
        alert("device " + data.deviceName + " has been created");
      } else {
        alert("Error: " + data.error);
      }

      var learningModeOn = false;
      if (document.getElementById("learningOn").checked) {
        learningModeOn = true;
      }
      socketio.emit("pullDevices", {
        user: user,
        learningModeOn: learningModeOn
      });


    });
    //creating updated list of known devices
    socketio.on("devicesUpdate", function(data) {
      // console.log("Listing " + data.deviceName);
      var myNode = document.getElementById("devices");
      if (data.first === true) {
        while (myNode.firstChild) {
            myNode.removeChild(myNode.firstChild);
        }
        // myNode.innerHTML = "Identified devices: ";
      }
      var new_row = myNode.appendChild(document.createElement("tr"));

      myNode.appendChild(document.createElement("td"));
      new_row.insertCell(0).innerHTML = data.deviceName;

      //appendChild(document.createTextNode("Device: " + data.deviceName)); // + " Current: " + data.current + " Voltage: " + data.voltage + " Power: " + data.realP));

    });

    socketio.on("devicesPowered", function(data) {
      var myNode = document.getElementById("successDevices");
      if (data.first === true) {
        while (myNode.firstChild) {
            myNode.removeChild(myNode.firstChild);
        }
        // myNode.innerHTML = "Currently Powered Devices: ";
      }
      myNode.appendChild(document.createElement("tr"));
      myNode.appendChild(document.createElement("td"));
      myNode.appendChild(document.createTextNode("Device: " + data.deviceName)); // + " Current: " + data.current + " Voltage: " + data.voltage + " Power: " + data.realP));

    });
    //
    // //creating updated list of "on devices"
    // socketio.on("successDevicesUpdate", function(data) {
    //   alert("entered successdevicesUpdate");
    //   if (data.first === true) {
    //     document.getElementById("successDevices").innerHTML = "Currently powered devices: ";
    //   }
    //   document.getElementById("successDevices").appendChild(document.createElement("br"));
    //   document.getElementById("successDevices").appendChild(document.createTextNode("Device: " + data.deviceName + " Current: " + data.current + " Voltage: " + data.voltage + " Power: " + data.realP));
    // });

    socketio.on("requestName", function(data) {
      document.getElementById("Circuit_Controls").style.display = "block";
      alert("Unrecognized device connected to system! Please name it");
      alert(data.mostRecent);

    });


    //ALL BELOW IS GRAPH BUILDER

    //global graphing vars
    var chart1DataX = [];
    var chart1DataY= [];
    var chart1DataY2= [];
    var prevE = 0.0;

    //update result return, prepare for graph building
    socketio.on("updateResult", function(data) {

      if(data.clearGraphs){
        chart1DataX = [];
        chart1DataY = [];
        chart1DataY2= [];
        prevE = 0;

      }
      chart1DataX.push(data.x);
      chart1DataY.push(data.y);

      chart1DataY2.push(parseFloat(data.y2) + (prevE));
      prevE += parseFloat(data.y2);


      //FIXME: for making harmonics
      // chartHDataX.push(data.xH);
      // chartHDataY.push(data.yH);
      if (data.final) {
        // chartMaker(chart1DataX, chart1DataY, "powerChart");
        // FIXME: for making harmonics
        // chartMaker(chartHDataX, chartHDataY, "harmonics");
        // chartMaker(data.xH, data.yH, "harmonicsChart");
        setHarmonicBars(data.xH, data.yH);

        var trace1 = {
          x: chart1DataX,
          y: chart1DataY,
          mode: 'lines+markers',
          line: {shape: 'linear'},
          type: 'scatter',
          name: 'Power (W)'
        };
        var trace2 = {
          x: chart1DataX,
          y: chart1DataY2,
          yaxis:'y2',
          mode: 'lines+markers',
          line: {shape: 'vh'},
          type: 'scatter',
          name: 'Energy (W-h)'
        };

        var data = [trace1, trace2];

        var layout = {
          autosize: false,
          width: 500,
          height: 500,
          margin: {
            l: 50,
            r: 50,
            b: 100,
            t: 100,
            pad: 4
          },
          yaxis: {title: 'Power (Watts)'},
         yaxis2: {
           title: 'Energy (Watt-Hours)',
           overlaying: 'y',
           side: 'right'
         },
         legend: {x:0.5,y:-0.5},
          paper_bgcolor: '#7f7f7f',
          plot_bgcolor: '#c7c7c7'

        };


        Plotly.newPlot("powerChart", data, layout);

      }


    });

    function setHarmonicBars(xH, yH){
        // h1_bar
        // <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 100%;" id="h1_bar">
        var numHarmonics = 6;
        for (var i = 0; i < numHarmonics; i++) {
          let id = "h" + (i+1) + "_bar";
          let hBar = document.getElementById(id);
          hBar.style = "width: " + yH[i] + "%";
          // hBar.(aria-valuenow) = yH[i];
          id = "h" + (i+1) + "_bar_label";
          hBar = document.getElementById(id);
          if(hBar) {
            hBar.removeChild(hBar.firstChild);
            hBar.appendChild(document.createTextNode(yH[i] + "%"));
          }

        }
    }

    function chartMaker(chartDataX, chartDataY, elementID) {
      //below is Easle.JS work to create charts
      var stacksDiv = document.getElementById(elementID);
      var traces = [{
          x: chartDataX,
          y: chartDataY,
          mode: 'lines+markers',
          line: {shape: 'linear'}, //FIXME: needs to be different for harmonics, use vhv or linear
          type: 'scatter',
          name: 'Power'
        },];

      var layout = {
        autosize: false,
        width: 500,
        height: 500,
        margin: {
          l: 50,
          r: 50,
          b: 100,
          t: 100,
          pad: 4
        },
        paper_bgcolor: '#7f7f7f',
        plot_bgcolor: '#c7c7c7'

      };

      // Plotly.newPlot(stacksDiv, stackedArea(traces), layout);
      Plotly.newPlot(stacksDiv, traces, layout);
    }

    function stackedArea(traces) {
      for (var i = 1; i < traces.length; i++) {
        for (var j = 0; j < (Math.min(traces[i]['y'].length, traces[i - 1]['y'].length)); j++) {
          traces[i]['y'][j] += traces[i - 1]['y'][j];
        }
      }
      return traces;
    }

  </script>

  </script>
</body>

</html>
